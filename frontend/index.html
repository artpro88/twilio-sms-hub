<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio SMS Integration</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-sms me-2"></i>
                SMS Hub
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-tab="config">
                            <i class="fas fa-cog me-1"></i>Configuration
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="send-sms">
                            <i class="fas fa-paper-plane me-1"></i>Send SMS
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="bulk-sms">
                            <i class="fas fa-upload me-1"></i>Bulk SMS
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="history">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="stats">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </a>
                    </li>
                </ul>
                <div class="navbar-text">
                    <i class="fas fa-wallet me-1"></i>
                    <span id="account-balance">Loading...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">

        <!-- Configuration Tab -->
        <div id="config" class="tab-content active">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="fas fa-cog text-primary me-2"></i>
                                Twilio Configuration
                            </h4>
                            <div id="config-status" class="badge bg-secondary">
                                <i class="fas fa-circle me-1" id="status-icon"></i>
                                <span id="status-text">Checking...</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="config-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="account-sid" class="form-label">
                                                <i class="fas fa-key text-primary me-1"></i>
                                                Account SID
                                            </label>
                                            <input type="text" class="form-control" id="account-sid"
                                                   placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Found in your <a href="https://console.twilio.com/" target="_blank">Twilio Console</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="auth-token" class="form-label">
                                                <i class="fas fa-lock text-primary me-1"></i>
                                                Auth Token
                                            </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="auth-token"
                                                       placeholder="Your auth token" required>
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="togglePassword('auth-token')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Found in your <a href="https://console.twilio.com/" target="_blank">Twilio Console</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <h5 class="mb-3">
                                    <i class="fas fa-id-card text-primary me-2"></i>
                                    Sender Configuration
                                </h5>

                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sender-type"
                                               id="sender-phone" value="phone" checked>
                                        <label class="form-check-label" for="sender-phone">
                                            <i class="fas fa-phone me-1"></i>
                                            Phone Number
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sender-type"
                                               id="sender-alphanumeric" value="alphanumeric">
                                        <label class="form-check-label" for="sender-alphanumeric">
                                            <i class="fas fa-font me-1"></i>
                                            Alphanumeric Sender ID
                                        </label>
                                    </div>
                                </div>

                                <div id="phone-number-group" class="mb-3">
                                    <label for="phone-number-config" class="form-label">
                                        <i class="fas fa-phone text-primary me-1"></i>
                                        Twilio Phone Number
                                    </label>
                                    <input type="tel" class="form-control" id="phone-number-config"
                                           placeholder="+1234567890">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Your Twilio phone number (include country code)
                                    </div>
                                </div>

                                <div id="sender-id-group" class="mb-3" style="display: none;">
                                    <label for="sender-id-config" class="form-label">
                                        <i class="fas fa-font text-primary me-1"></i>
                                        Alphanumeric Sender ID
                                    </label>
                                    <input type="text" class="form-control" id="sender-id-config"
                                           placeholder="YourBrand" maxlength="11">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Up to 11 characters (letters, numbers, spaces).
                                        <a href="https://help.twilio.com/articles/223133967" target="_blank">Learn more</a>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        Save Configuration
                                    </button>
                                    <button type="button" id="test-config" class="btn btn-outline-secondary">
                                        <i class="fas fa-vial me-1"></i>
                                        Test Connection
                                    </button>
                                    <button type="button" id="debug-config" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-bug me-1"></i>
                                        Debug
                                    </button>
                                </div>
                            </form>

                            <div id="config-result" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-question-circle text-info me-2"></i>
                                Getting Started
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                <div class="badge bg-primary rounded-circle me-3" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">1</div>
                                <div>
                                    <h6>Create Twilio Account</h6>
                                    <small class="text-muted">Sign up for a <a href="https://www.twilio.com/try-twilio" target="_blank">free Twilio account</a></small>
                                </div>
                            </div>
                            <div class="d-flex align-items-start mb-3">
                                <div class="badge bg-primary rounded-circle me-3" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">2</div>
                                <div>
                                    <h6>Get Credentials</h6>
                                    <small class="text-muted">Copy your Account SID and Auth Token from the <a href="https://console.twilio.com/" target="_blank">Twilio Console</a></small>
                                </div>
                            </div>
                            <div class="d-flex align-items-start mb-3">
                                <div class="badge bg-primary rounded-circle me-3" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">3</div>
                                <div>
                                    <h6>Choose Sender</h6>
                                    <small class="text-muted">Either purchase a <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/search" target="_blank">phone number</a> or use an alphanumeric sender ID</small>
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <div class="badge bg-primary rounded-circle me-3" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">4</div>
                                <div>
                                    <h6>Configure & Test</h6>
                                    <small class="text-muted">Enter your credentials and test the connection</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-link text-warning me-2"></i>
                                Webhook Configuration
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Configure webhooks in your Twilio Console to receive SMS delivery status and incoming messages.
                            </p>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">Webhook URL (for both incoming SMS and status callbacks):</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" readonly
                                           value="https://web-production-f2175.up.railway.app/api/webhooks/incoming">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="copyToClipboard('https://web-production-f2175.up.railway.app/api/webhooks/incoming')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Use this same URL for both "A message comes in" and "Primary handler fails" in Twilio Console.
                                </div>
                            </div>

                            <div class="alert alert-warning small mb-0">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Important:</strong> In your
                                <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming" target="_blank">
                                    Twilio Phone Numbers settings
                                </a>, set this URL for:
                                <ul class="mb-0 mt-2">
                                    <li><strong>"A message comes in"</strong> (Primary Handler)</li>
                                    <li><strong>"Primary handler fails"</strong> (Fallback Handler)</li>
                                </ul>
                                <small class="text-muted">Twilio allows only ONE webhook URL per phone number.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Safe List Management -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt text-success me-2"></i>
                                Global Safe List
                            </h5>
                            <small class="text-muted">Manage phone numbers in Twilio's Global Safe List (no charges for SMS to these numbers)</small>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="safelist-phone" class="form-label">Phone Number</label>
                                <div class="input-group">
                                    <input type="tel" class="form-control" id="safelist-phone"
                                           placeholder="+1234567890" required>
                                    <button type="button" class="btn btn-success" id="add-to-safelist">
                                        <i class="fas fa-plus me-1"></i>Add
                                    </button>
                                </div>
                                <div class="form-text">Enter phone number in E.164 format (e.g., +1234567890)</div>
                            </div>

                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="load-safelist">
                                    <i class="fas fa-refresh me-1"></i>Load Safe List
                                </button>
                            </div>

                            <div id="safelist-result" class="mt-3"></div>

                            <div id="safelist-container" class="mt-3" style="display: none;">
                                <h6>Current Safe List:</h6>
                                <div id="safelist-items" class="list-group">
                                    <!-- Safe list items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send SMS Tab -->
        <div id="send-sms" class="tab-content">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">
                                <i class="fas fa-paper-plane text-primary me-2"></i>
                                Send Single SMS
                            </h4>
                            <small class="text-muted">Send individual SMS messages with real-time delivery tracking</small>
                        </div>
                        <div class="card-body">
                            <form id="send-sms-form">
                                <div class="mb-3">
                                    <label for="phone-number" class="form-label">
                                        <i class="fas fa-phone text-primary me-1"></i>
                                        Recipient Phone Number
                                    </label>
                                    <input type="tel" class="form-control" id="phone-number"
                                           placeholder="+1234567890" required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Include country code (e.g., +1 for US, +44 for UK)
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="message-body" class="form-label">
                                        <i class="fas fa-comment text-primary me-1"></i>
                                        Message Content
                                    </label>
                                    <textarea class="form-control" id="message-body" rows="4"
                                              placeholder="Type your message here..."
                                              maxlength="1600" required></textarea>
                                    <div class="d-flex justify-content-between">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            SMS messages over 160 characters will be sent as multiple segments
                                        </div>
                                        <div class="text-muted small">
                                            <span id="char-count">0</span>/1600 characters
                                            <span class="ms-2" id="segment-count">1 segment</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>
                                        Send SMS
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="clear-form">
                                        <i class="fas fa-eraser me-1"></i>
                                        Clear
                                    </button>
                                </div>
                            </form>

                            <div id="send-result" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                SMS Best Practices
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-clock text-primary fs-4 mb-2"></i>
                                        <h6>Timing</h6>
                                        <small class="text-muted">Send during business hours</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-user-check text-success fs-4 mb-2"></i>
                                        <h6>Consent</h6>
                                        <small class="text-muted">Ensure opt-in compliance</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-text-width text-info fs-4 mb-2"></i>
                                        <h6>Length</h6>
                                        <small class="text-muted">Keep under 160 chars</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-shield-alt text-danger fs-4 mb-2"></i>
                                        <h6>Compliance</h6>
                                        <small class="text-muted">Follow regulations</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk SMS Tab -->
        <div id="bulk-sms" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-upload text-primary me-2"></i>
                        Bulk SMS Campaign
                    </h4>
                    <small class="text-muted">Send personalized messages to multiple recipients from CSV files</small>
                </div>
                <div class="card-body">
                    <form id="bulk-sms-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="csv-file" class="form-label">
                                        <i class="fas fa-file-csv text-primary me-1"></i>
                                        CSV File
                                    </label>
                                    <input type="file" class="form-control" id="csv-file" accept=".csv" required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Required column: phone_number. Optional: name, custom_field<br>
                                        <i class="fas fa-plus-circle me-1 text-success"></i>
                                        <strong>Auto-fix:</strong> Missing '+' country code prefixes will be added automatically<br>
                                        <button type="button" class="btn btn-outline-secondary btn-sm mt-1" onclick="downloadSampleCSV()">
                                            <i class="fas fa-download me-1"></i>Download Sample CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="message-template" class="form-label">
                                        <i class="fas fa-comment-alt text-primary me-1"></i>
                                        Message Template
                                    </label>
                                    <textarea class="form-control" id="message-template" rows="3"
                                              placeholder="Hello {name}, this is a message for you!"
                                              maxlength="1600" required></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Use {name} and {custom_field} as placeholders
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-rocket me-1"></i>
                            Launch Campaign
                        </button>
                        <button type="button" class="btn btn-warning ms-2" onclick="troubleshootBulkSMS()">
                            <i class="fas fa-bug me-1"></i>
                            Troubleshoot
                        </button>
                    </form>

                    <div id="bulk-result" class="mt-3"></div>

                    <hr class="my-4">

                    <h5>
                        <i class="fas fa-tasks text-primary me-2"></i>
                        Campaign Jobs
                    </h5>
                    <div id="bulk-jobs-list">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading campaigns...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-history text-primary me-2"></i>
                        Message History
                    </h4>
                    <div class="d-flex gap-2">
                        <select id="history-filter" class="form-select form-select-sm">
                            <option value="all">All Messages</option>
                            <option value="outbound">Sent Messages</option>
                            <option value="inbound">Received Messages</option>
                            <option value="delivered">Delivered</option>
                            <option value="failed">Failed</option>
                        </select>
                        <button id="refresh-history" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-sync me-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="sms-history">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading message history...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content">
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-paper-plane fs-1 mb-2"></i>
                            <h3 id="total-sent">0</h3>
                            <p class="mb-0">Messages Sent</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fs-1 mb-2"></i>
                            <h3 id="total-delivered">0</h3>
                            <p class="mb-0">Delivered</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body text-center">
                            <i class="fas fa-times-circle fs-1 mb-2"></i>
                            <h3 id="total-failed">0</h3>
                            <p class="mb-0">Failed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <i class="fas fa-dollar-sign fs-1 mb-2"></i>
                            <h3 id="total-cost">$0.00</h3>
                            <p class="mb-0">Total Cost</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-day text-primary me-2"></i>
                                Today's Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span>Sent:</span>
                                <strong id="today-sent">0</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Delivered:</span>
                                <strong id="today-delivered">0</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Cost:</span>
                                <strong id="today-cost">$0.00</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                This Month
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span>Sent:</span>
                                <strong id="month-sent">0</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Delivered:</span>
                                <strong id="month-delivered">0</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Cost:</span>
                                <strong id="month-cost">$0.00</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
         style="background: rgba(0,0,0,0.5); z-index: 1050;">
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="bg-white p-4 rounded text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Processing...</div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>

    <script>
        // Simple JavaScript functions for immediate functionality
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                button.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                button.className = 'fas fa-eye';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success feedback
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0';
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check me-2"></i>Copied to clipboard!
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;

                const toastContainer = document.getElementById('toast-container');
                toastContainer.appendChild(toast);

                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();

                // Remove toast after it's hidden
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        }

        function downloadSampleCSV() {
            // Create sample CSV content with your example data
            const csvContent = `phone_number,name,custom_field
447960858925,Artur,50
447538982387,Alina,250
1234567890,John Doe,100
44123456789,Jane Smith,75`;

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_bulk_sms.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Show success message
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-info border-0';
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-download me-2"></i>Sample CSV downloaded! Note: + prefixes will be added automatically.
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            const toastContainer = document.getElementById('toast-container');
            toastContainer.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function troubleshootBulkSMS() {
            const fileInput = document.getElementById('csv-file');
            const messageTemplate = document.getElementById('message-template').value;

            if (!fileInput.files[0]) {
                alert('Please select a CSV file first');
                return;
            }

            if (!messageTemplate) {
                alert('Please enter a message template');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('message_template', messageTemplate);

            // Show loading
            const resultDiv = document.getElementById('bulk-result');
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Running comprehensive troubleshooting (test mode - no real SMS sent)...
                </div>
            `;

            // Default to test mode (no real SMS sent)
            formData.append('send_real_sms', 'false');

            fetch('/api/troubleshoot/bulk-sms', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Display detailed troubleshooting results
                let html = '<div class="card"><div class="card-header"><h5>Bulk SMS Troubleshooting Report</h5></div><div class="card-body">';

                html += `<p><strong>Timestamp:</strong> ${data.timestamp}</p>`;
                html += `<p><strong>Final Diagnosis:</strong> <span class="badge bg-${data.final_diagnosis.includes('working') ? 'success' : 'danger'}">${data.final_diagnosis}</span></p>`;

                if (data.recommendations && data.recommendations.length > 0) {
                    html += '<h6>Recommendations:</h6><ul>';
                    data.recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += '</ul>';
                }

                html += '<h6>Detailed Steps:</h6>';
                data.steps.forEach(step => {
                    const badgeClass = step.status === 'success' ? 'bg-success' : step.status === 'warning' ? 'bg-warning' : 'bg-danger';
                    html += `
                        <div class="mb-2">
                            <span class="badge ${badgeClass}">${step.status.toUpperCase()}</span>
                            <strong>${step.step}:</strong> ${step.details}
                            ${step.data ? `<details class="mt-1"><summary>View Data</summary><pre>${JSON.stringify(step.data, null, 2)}</pre></details>` : ''}
                        </div>
                    `;
                });

                html += '</div></div>';
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Troubleshooting Error:</strong> ${error.message}
                    </div>
                `;
            });
        }

        // Tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link[data-tab]');
            const tabContents = document.querySelectorAll('.tab-content');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Remove active class from all nav links
                    navLinks.forEach(nl => nl.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');

                    // Hide all tab contents
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    // Show selected tab content
                    const targetTab = document.getElementById(this.dataset.tab);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });

            // Sender type radio buttons
            const senderRadios = document.querySelectorAll('input[name="sender-type"]');
            senderRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const phoneGroup = document.getElementById('phone-number-group');
                    const senderIdGroup = document.getElementById('sender-id-group');

                    if (this.value === 'phone') {
                        phoneGroup.style.display = 'block';
                        senderIdGroup.style.display = 'none';
                        document.getElementById('phone-number-config').required = true;
                        document.getElementById('sender-id-config').required = false;
                    } else {
                        phoneGroup.style.display = 'none';
                        senderIdGroup.style.display = 'block';
                        document.getElementById('phone-number-config').required = false;
                        document.getElementById('sender-id-config').required = true;
                    }
                });
            });

            // Character counter for message body
            const messageBody = document.getElementById('message-body');
            if (messageBody) {
                messageBody.addEventListener('input', function() {
                    const charCount = this.value.length;
                    const charCountElement = document.getElementById('char-count');
                    const segmentCountElement = document.getElementById('segment-count');

                    if (charCountElement) {
                        charCountElement.textContent = charCount;
                    }

                    if (segmentCountElement) {
                        const segments = Math.ceil(charCount / 160) || 1;
                        segmentCountElement.textContent = segments + ' segment' + (segments !== 1 ? 's' : '');
                    }
                });
            }

            // Debug button
            const debugButton = document.getElementById('debug-config');
            if (debugButton) {
                debugButton.addEventListener('click', async function() {
                    try {
                        const response = await fetch('/api/config/status');
                        const result = await response.json();
                        console.log('Configuration Debug:', result);
                        alert('Debug info logged to console. Check browser developer tools.');
                    } catch (error) {
                        console.error('Debug error:', error);
                        alert('Debug failed. Check console for details.');
                    }
                });
            }

            // Initialize the app
            if (typeof SMSApp !== 'undefined') {
                window.smsApp = new SMSApp();
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/app.js"></script>
</body>
</html>
